<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Firebase Email Link Auth</title>
  <!-- TODO: Add your Firebase SDK config scripts -->
  <script type="module">
    // Import Firebase Auth modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink,
             signInWithEmailLink, linkWithCredential,
             reauthenticateWithCredential, signOut, EmailAuthProvider } 
      from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

    // TODO: Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      // ... other config
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Configure email link settings
    const actionCodeSettings = {
      url: 'https://www.example.com/finishSignUp?cartId=1234',
      handleCodeInApp: true,
      iOS: { bundleId: 'com.example.ios' },
      android: {
        packageName: 'com.example.android',
        installApp: true,
        minimumVersion: '12'
      },
      linkDomain: 'custom-domain.com'
    };

    // On form submit: send link to email
    window.sendLink = async () => {
      const email = document.getElementById('email').value;
      try {
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        window.localStorage.setItem('emailForSignIn', email);
        alert('Check your email for the sign-in link.');
      } catch (err) {
        console.error(err);
        alert('Error sending email link: ' + err.message);
      }
    };

    // On load: check if being opened via email link
    window.addEventListener('load', async () => {
      if (isSignInWithEmailLink(auth, window.location.href)) {
        let email = window.localStorage.getItem('emailForSignIn');
        if (!email) {
          email = window.prompt('Please re-enter your email for confirmation');
        }
        try {
          const result = await signInWithEmailLink(auth, email, window.location.href);
          window.localStorage.removeItem('emailForSignIn');
          alert('Signed in successfully!');
          // Now you can optionally link phone/email or reauthenticate
        } catch (err) {
          console.error(err);
          alert('Error signing in with link: ' + err.message);
        }
      }
    });

    // Example: Link email credential to existing user
    window.linkEmail = async () => {
      const email = document.getElementById('emailToLink').value;
      const credential = EmailAuthProvider.credentialWithLink(email, window.location.href);
      try {
        await linkWithCredential(auth.currentUser, credential);
        alert('Email successfully linked to your account.');
      } catch (err) {
        console.error(err);
        alert('Linking failed: ' + err.message);
      }
    };

    // Example: Reauthenticate for sensitive operations
    window.reauth = async () => {
      const email = document.getElementById('reauthEmail').value;
      const credential = EmailAuthProvider.credentialWithLink(email, window.location.href);
      try {
        await reauthenticateWithCredential(auth.currentUser, credential);
        alert('Re-authentication successful.');
      } catch (err) {
        console.error(err);
        alert('Re-authentication failed: ' + err.message);
      }
    };

    // Sign out
    window.doSignOut = async () => {
      try {
        await signOut(auth);
        alert('Signed out.');
      } catch (err) {
        console.error(err);
        alert('Sign-out error: ' + err.message);
      }
    };
  </script>
</head>
<body>
  <h1>Firebase Email Link Auth Demo</h1>
  <section>
    <h2>1. Send Sign‑In Link</h2>
    <input id="email" type="email" placeholder="Enter your email" />
    <button onclick="sendLink()">Send Sign-In Link</button>
  </section>

  <section>
    <h2>2. Link Email to Existing User</h2>
    <input id="emailToLink" type="email" placeholder="Email you're linking" />
    <button onclick="linkEmail()">Link Email</button>
  </section>

  <section>
    <h2>3. Re‑authenticate</h2>
    <input id="reauthEmail" type="email" placeholder="Email for re‑auth" />
    <button onclick="reauth()">Re‑authenticate</button>
  </section>

  <section>
    <h2>4. Sign Out</h2>
    <button onclick="doSignOut()">Sign Out</button>
  </section>
</body>
</html>
